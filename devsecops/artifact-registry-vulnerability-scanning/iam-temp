export CLOUDBUILD_SA=890802265070@cloudbuild.gserviceaccount.com
export PROJECT_ID=phx-01hnn9wb0eg
export REGION=northamerica-northeast1
export REPO_NAME=$PROJECT_ID-vuln-cloudfunction

CLOUDBUILD_SA=890802265070@cloudbuild.gserviceaccount.com
PROJECT_ID="phx-01j1tbke0ax"
REGION="northamerica-northeast1"
REPO_NAME="$PROJECT_ID-vuln-cloudfunction"

  # Create the artifact registry repo for the cloud function 
  - >      
    gcloud artifacts repositories create $PROJECT_ID-vuln-cloudfunction \
    --repository-format=docker \
    --location=northamerica-northeast1 \
    --description="Artifact registry for safeinputs cloud function images"

  # Create the vuln cloud function runtime service account: 
  - >   
    gcloud iam service-accounts create $PROJECT_ID-vgcf-runtime \
    --display-name="Vulnerability Cloud Function runtime" \
    --description="To be used as the cloud function runtime service account to be able to pick off occurrences from container analysis and save to bucket."
  
  # Create the vuln cloud function build  service account: 
  - >          
    gcloud iam service-accounts create $PROJECT_ID-vgcf-build \
    --display-name="Vulnerability Cloud Function build" \
    --description="To be used as the cloud function build account (to separate from cloud build to eliminate circular dependency)."
 
  # Assign Cloud Functions Developer role to Cloud Build
  - >   
    gcloud projects add-iam-policy-binding "$PROJECT_ID" \
      --member="serviceAccount:$CLOUDBUILD_SA" \
      --role="roles/cloudfunctions.developer"

  # Assign Container Analysis Occurrences Viewer to cloud function runtime account 
  - >   
    gcloud projects add-iam-policy-binding "$PROJECT_ID" \
      --member="serviceAccount:$PROJECT_ID-vgcf-runtime@$PROJECT_ID.iam.gserviceaccount.com" \
      --role="roles/containeranalysis.occurrences.viewer"

  # Assign Storage Object User role to cloud function runtime and build service accounts
  - >   
    gcloud projects add-iam-policy-binding "$PROJECT_ID" \
      --member="serviceAccount:$PROJECT_ID-vgcf-runtime@$PROJECT_ID.iam.gserviceaccount.com" \
      --role="roles/storage.objectUser"
  - >   
    gcloud projects add-iam-policy-binding "$PROJECT_ID" \
      --member="serviceAccount:$PROJECT_ID-vgcf-build@$PROJECT_ID.iam.gserviceaccount.com" \
      --role="roles/storage.objectUser"

  # Assign Run Invoker role to cloud runction runtime service account
  - >   
    gcloud projects add-iam-policy-binding "$PROJECT_ID" \
      --member="serviceAccount:$PROJECT_ID-vgcf-runtime@$PROJECT_ID.iam.gserviceaccount.com" \
      --role="roles/run.invoker"

  # Assign Storage Object Viewer role to cloudbuild and gcf build accounts

; gcloud projects add-iam-policy-binding "$PROJECT_ID" \
;   --member="serviceAccount:phx-01j1tbke0ax-cloudbuild@$PROJECT_ID.iam.gserviceaccount.com" \
;   --role="roles/storage.objectViewer"

  - >   
    gcloud projects add-iam-policy-binding "$PROJECT_ID" \
      --member="serviceAccount:$PROJECT_ID-vgcf-build@$PROJECT_ID.iam.gserviceaccount.com" \
      --role="roles/storage.objectViewer"

  # Assign IAM bindings for Artifact Registry writer and reader roles for cloud function service accounts
  - >   
    gcloud artifacts repositories add-iam-policy-binding "$REPO_NAME" \
      --location="$REGION" \
      --member="serviceAccount:$PROJECT_ID-vgcf-build@$PROJECT_ID.iam.gserviceaccount.com" \
      --role="roles/artifactregistry.writer"
  - >   
    gcloud artifacts repositories add-iam-policy-binding "$REPO_NAME" \
      --location="$REGION" \
      --member="serviceAccount:$PROJECT_ID-vgcf-runtime@$PROJECT_ID.iam.gserviceaccount.com" \
      --role="roles/artifactregistry.reader"
  - >   
    gcloud artifacts repositories add-iam-policy-binding "$REPO_NAME" \
      --location="$REGION" \
      --member="serviceAccount:$PROJECT_ID-vgcf-build@$PROJECT_ID.iam.gserviceaccount.com" \
      --role="roles/artifactregistry.reader"

